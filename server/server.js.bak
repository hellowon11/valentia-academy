const express = require('express');
const nodemailer = require('nodemailer');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const ExcelJS = require('exceljs');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
require('dotenv').config();

// Import database
const {
  generateApplicationId,
  applications,
  attachments,
  notes,
  statusHistory,
  adminUsers
} = require('./database');

const app = express();

// Create uploads directory if it doesn't exist
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}

// Multer configuration for file uploads - save to disk for admin access
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, uploadsDir);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + '-' + file.originalname);
  }
});

const upload = multer({ 
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB limit
    files: 5 // Maximum 5 files
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type. Only PDF, JPG, PNG, DOC, DOCX files are allowed.'), false);
    }
  }
});

// Middleware
app.use(express.json());
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}));

// Email transporter configuration
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS
  }
});

// Verify email configuration on startup
transporter.verify((error, success) => {
  if (error) {
    console.error('âŒ Email configuration error:', error);
  } else {
    console.log('âœ… Email server is ready to send messages');
  }
});

// Function to get course information based on language and course type
const getCourseInfo = (language, course) => {
  const courseInfo = {
    en: {
      advanced: {
        title: 'Advanced Cabin Crew Diploma',
        duration: '1 Year',
        description: 'Comprehensive training for international airlines'
      },
      english: {
        title: 'English Language Proficiency',
        duration: '6 Months',
        description: 'Aviation English and communication skills'
      },
      basic: {
        title: 'Basic Cabin Crew Training',
        duration: '6 Months',
        description: 'Foundation course for aviation career'
      }
    },
    zh: {
      advanced: {
        title: 'é«˜çº§ç©ºä¹˜æ–‡å‡­',
        duration: '1å¹´',
        description: 'å›½é™…èˆªç©ºå…¬å¸ç»¼åˆåŸ¹è®­'
      },
      english: {
        title: 'è‹±è¯­è¯­è¨€èƒ½åŠ›æå‡',
        duration: '6ä¸ªæœˆ',
        description: 'èˆªç©ºè‹±è¯­å’Œæ²Ÿé€šæŠ€å·§'
      },
      basic: {
        title: 'åŸºç¡€ç©ºä¹˜åŸ¹è®­',
        duration: '6ä¸ªæœˆ',
        description: 'èˆªç©ºèŒä¸šåŸºç¡€è¯¾ç¨‹'
      }
    },
    ko: {
      advanced: {
        title: 'ê³ ê¸‰ ê°ì‹¤ìŠ¹ë¬´ì› ë””í”Œë¡œë§ˆ',
        duration: '1ë…„',
        description: 'êµ­ì œ í•­ê³µì‚¬ ì¢…í•© êµìœ¡'
      },
      english: {
        title: 'ì˜ì–´ ëŠ¥ë ¥ í–¥ìƒ ê³¼ì •',
        duration: '6ê°œì›”',
        description: 'í•­ê³µ ì˜ì–´ ë° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ê¸°ìˆ '
      },
      basic: {
        title: 'ê¸°ë³¸ ê°ì‹¤ìŠ¹ë¬´ì› êµìœ¡',
        duration: '6ê°œì›”',
        description: 'í•­ê³µ ê²½ë ¥ ê¸°ì´ˆ ê³¼ì •'
      }
    },
    ja: {
      advanced: {
        title: 'ä¸Šç´šã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‡ã‚£ãƒ—ãƒ­ãƒ',
        duration: '1å¹´',
        description: 'å›½éš›èˆªç©ºä¼šç¤¾å‘ã‘ç·åˆè¨“ç·´'
      },
      english: {
        title: 'è‹±èªèƒ½åŠ›å‘ä¸Šã‚³ãƒ¼ã‚¹',
        duration: '6ãƒ¶æœˆ',
        description: 'èˆªç©ºè‹±èªã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ«'
      },
      basic: {
        title: 'åŸºæœ¬ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼è¨“ç·´',
        duration: '6ãƒ¶æœˆ',
        description: 'èˆªç©ºã‚­ãƒ£ãƒªã‚¢åŸºç¤ã‚³ãƒ¼ã‚¹'
      }
    }
  };
  
  return courseInfo[language]?.[course] || courseInfo.en[course] || courseInfo.en.basic;
};

// Auto-reply templates in different languages
const getAutoReplyTemplate = (language, name, userMessage, course) => {
  const templates = {
    en: {
      subject: 'Thank you for your inquiry - Valentia Cabin Crew Academy',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Valentia Cabin Crew Academy</title>
          <style>
            @media only screen and (max-width: 600px) {
              .email-container {
                width: 100% !important;
                max-width: 380px !important;
                border-radius: 20px !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
                overflow: hidden !important;
                margin: 0 auto !important;
              }
              .email-header {
                background: linear-gradient(135deg, #1a252f 0%, #2c3e50 50%, #34495e 100%) !important;
                padding: 36px 20px !important;
                position: relative !important;
              }
              .email-header::before {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(45deg, rgba(52, 152, 219, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%) !important;
                pointer-events: none !important;
              }
              .logo-container {
                width: 80px !important;
                height: 80px !important;
                line-height: 80px !important;
                border: 4px solid rgba(255,255,255,0.2) !important;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .logo-text {
                font-size: 32px !important;
                font-weight: 700 !important;
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
                -webkit-background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                background-clip: text !important;
              }
              .header-title {
                font-size: 26px !important;
                font-weight: 700 !important;
                letter-spacing: 2px !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .header-subtitle {
                font-size: 14px !important;
                font-weight: 500 !important;
                margin: 8px 0 0 0 !important;
                color: #ecf0f1 !important;
                letter-spacing: 1px !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .header-tagline {
                font-size: 12px !important;
                letter-spacing: 1.5px !important;
                font-weight: 600 !important;
                margin: 16px 0 0 0 !important;
                color: #bdc3c7 !important;
                text-transform: uppercase !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .email-content {
                padding: 28px 20px !important;
                background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%) !important;
              }
              .content-title {
                font-size: 30px !important;
                font-weight: 700 !important;
                margin-bottom: 24px !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .content-text {
                margin-bottom: 20px !important;
                line-height: 1.7 !important;
                font-size: 19px !important;
                color: #34495e !important;
              }
              .content-text-large {
                margin-bottom: 28px !important;
                line-height: 1.7 !important;
                font-size: 19px !important;
                color: #34495e !important;
              }
              .section-container {
                margin: 28px 0 !important;
                border-radius: 12px !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
                box-shadow: 0 4px 16px rgba(0,0,0,0.08) !important;
                border: 1px solid #e9ecef !important;
              }
              .section-content {
                padding: 24px !important;
              }
              .section-title {
                font-size: 24px !important;
                font-weight: 700 !important;
                margin-bottom: 16px !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .section-box {
                padding: 20px !important;
                border-radius: 10px !important;
                background: #ffffff !important;
                border: 1px solid #e9ecef !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
                font-size: 18px !important;
                line-height: 1.6 !important;
              }
              .inquiry-section {
                border-left: 5px solid #3498db !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;
              }
              .course-section {
                border-left: 5px solid #27ae60 !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%) !important;
              }
              .contact-container {
                margin: 32px 0 !important;
              }
              .contact-button {
                padding: 18px 28px !important;
                border: 2px solid !important;
                border-radius: 14px !important;
                font-size: 20px !important;
                font-weight: 700 !important;
                min-width: 140px !important;
                margin: 0 10px 20px 10px !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
                background: #ffffff !important;
              }
              .contact-button:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
              }
              .email-button {
                border-color: #3498db !important;
                color: #3498db !important;
              }
              .website-button {
                border-color: #27ae60 !important;
                color: #27ae60 !important;
              }
              .social-container {
                margin: 28px 0 !important;
              }
              .social-text {
                margin-bottom: 20px !important;
                font-size: 18px !important;
                color: #7f8c8d !important;
                font-style: italic !important;
                font-weight: 500 !important;
              }
              .social-icon {
                width: 60px !important;
                height: 60px !important;
                border-radius: 18px !important;
                line-height: 60px !important;
                margin: 0 10px !important;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                overflow: hidden !important;
              }
              .social-icon::before {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%) !important;
                pointer-events: none !important;
              }
              .social-icon:hover {
                transform: translateY(-3px) !important;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
              }
              .social-icon-text {
                font-size: 24px !important;
                font-weight: 700 !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .social-icon-text-small {
                font-size: 22px !important;
                font-weight: 700 !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .email-footer {
                padding: 28px 20px !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                border-top: 1px solid #dee2e6 !important;
              }
              .footer-title {
                font-weight: 700 !important;
                font-size: 20px !important;
                margin: 6px 0 !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .footer-text {
                margin: 6px 0 !important;
                color: #6c757d !important;
                font-size: 17px !important;
                font-style: italic !important;
              }
            }
          </style>
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
          <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4;">
            <tr>
              <td align="center" style="padding: 20px 0;">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                  <!-- Header -->
                  <tr>
                    <td style="background-color: #2c3e50; padding: 40px 30px; text-align: center; border-radius: 8px 8px 0 0;">
                      <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td style="text-align: center;">
                            <div class="logo-container" style="width: 80px; height: 80px; background-color: #ffffff; border-radius: 50%; margin: 0 auto 20px auto; display: inline-block; line-height: 80px; text-align: center; border: 3px solid #bdc3c7;">
                              <span class="logo-text" style="font-size: 32px; font-weight: bold; color: #2c3e50;">V</span>
                            </div>
                            <h1 class="header-title" style="margin: 0; font-size: 28px; font-weight: 300; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">Valentia</h1>
                            <p class="header-subtitle" style="margin: 8px 0 0 0; font-size: 14px; color: #bdc3c7; font-style: italic; letter-spacing: 1px;">Cabin Crew Academy</p>
                            <p class="header-tagline" style="margin: 15px 0 0 0; font-size: 12px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px;">Excellence in Aviation Training</p>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Main Content -->
                  <tr>
                    <td class="email-content" style="padding: 40px 30px;">
                      <h2 class="content-title" style="color: #2c3e50; margin-bottom: 25px; font-size: 22px; font-weight: 400;">Dear ${name},</h2>
                      
                      <p class="content-text" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 20px;">
                        Thank you for your interest in <strong>Valentia Cabin Crew Academy</strong>. We are delighted to assist you in pursuing your aviation career aspirations.
                      </p>
                      
                      <p class="content-text-large" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 30px;">
                        We have received your inquiry and our dedicated team of aviation professionals will review your request and provide you with comprehensive information within <strong>24 hours</strong>.
                      </p>
                      
                      <!-- User Inquiry Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="section-container inquiry-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                        <tr>
                          <td class="section-content" style="padding: 25px;">
                            <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">Your Inquiry</h3>
                            <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                              ${userMessage.replace(/\n/g, '<br>')}
                            </div>
                          </td>
                        </tr>
                      </table>
                      
                      <!-- Training Programs Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="section-container course-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                        <tr>
                          <td class="section-content" style="padding: 25px;">
                            <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">Your Selected Course</h3>
                            <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                              <strong>${getCourseInfo(language, course).title}</strong> (${getCourseInfo(language, course).duration}) - ${getCourseInfo(language, course).description}
                            </div>
                          </td>
                        </tr>
                      </table>
                      
                      <p style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 35px;">
                        While you wait, please explore our website to learn more about our world-class training facilities, experienced instructors, and successful alumni network.
                      </p>
                      
                      <!-- Contact Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="contact-container" style="margin: 35px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 15px;">
                                  <a href="mailto:valentiacabincrew.academy@gmail.com" class="contact-button email-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">âœ‰</span>
                                    <span style="font-weight: 500;">Send Email</span>
                                  </a>
                                </td>
                                <td style="padding: 0 15px;">
                                  <a href="https://valentiaacademy.vercel.app/" class="contact-button website-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">ğŸŒ</span>
                                    <span style="font-weight: 500;">Visit Website</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                      
                      <!-- Social Media -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="social-container" style="margin: 30px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <p class="social-text" style="color: #7f8c8d; font-size: 13px; margin-bottom: 20px; font-style: italic;">Follow us for the latest updates and aviation industry insights</p>
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.instagram.com/jiehao_08/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text" style="font-size: 20px; color: white; font-weight: bold;">IG</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.linkedin.com/in/jie-hao-tee-4aa753290/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #0077b5; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text-small" style="font-size: 18px; color: white; font-weight: bold;">in</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.facebook.com/jie.hao.14/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #1877f2; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text" style="font-size: 20px; color: white; font-weight: bold;">f</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                                      <!-- Footer -->
                    <tr>
                      <td class="email-footer" style="text-align: center; color: #7f8c8d; padding: 30px; border-top: 1px solid #ecf0f1; border-radius: 0 0 8px 8px;">
                        <p class="footer-title" style="margin: 5px 0; font-weight: 400; color: #2c3e50;">Valentia Cabin Crew Academy</p>
                        <p class="footer-text" style="margin: 5px 0; font-size: 12px; font-style: italic;">Your journey to aviation excellence begins here</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
        </html>
      `
    },
    zh: {
      subject: 'æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ - Valentiaç©ºä¹˜å­¦é™¢',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Valentiaç©ºä¹˜å­¦é™¢</title>
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
          <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4;">
            <tr>
              <td align="center" style="padding: 20px 0;">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                  <!-- Header -->
                  <tr>
                    <td style="background-color: #2c3e50; padding: 40px 30px; text-align: center; border-radius: 8px 8px 0 0;">
                      <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td style="text-align: center;">
                            <div class="logo-container" style="width: 80px; height: 80px; background-color: #ffffff; border-radius: 50%; margin: 0 auto 20px auto; display: inline-block; line-height: 80px; text-align: center; border: 3px solid #bdc3c7;">
                              <span class="logo-text" style="font-size: 32px; font-weight: bold; color: #2c3e50;">V</span>
                            </div>
                            <h1 class="header-title" style="margin: 0; font-size: 28px; font-weight: 300; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">Valentia</h1>
                            <p class="header-subtitle" style="margin: 8px 0 0 0; font-size: 14px; color: #bdc3c7; font-style: italic; letter-spacing: 1px;">ç©ºä¹˜å­¦é™¢</p>
                            <p class="header-tagline" style="margin: 15px 0 0 0; font-size: 12px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px;">èˆªç©ºåŸ¹è®­å“è¶Šå…¸èŒƒ</p>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Main Content -->
                  <tr>
                    <td class="email-content" style="padding: 40px 30px;">
                      <h2 class="content-title" style="color: #2c3e50; margin-bottom: 25px; font-size: 22px; font-weight: 400;">äº²çˆ±çš„${name}ï¼Œ</h2>
                      
                      <p class="content-text" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 20px;">
                        æ„Ÿè°¢æ‚¨å¯¹<strong>Valentiaç©ºä¹˜å­¦é™¢</strong>çš„å…³æ³¨ã€‚æˆ‘ä»¬å¾ˆè£å¹¸èƒ½å¤ŸååŠ©æ‚¨è¿½æ±‚èˆªç©ºäº‹ä¸šç†æƒ³ã€‚
                      </p>
                      
                      <p class="content-text-large" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 30px;">
                        æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„å’¨è¯¢ï¼Œæˆ‘ä»¬çš„ä¸“ä¸šèˆªç©ºå›¢é˜Ÿå°†å®¡æ ¸æ‚¨çš„éœ€æ±‚å¹¶åœ¨<strong>24å°æ—¶å†…</strong>ä¸ºæ‚¨æä¾›å…¨é¢çš„ä¿¡æ¯ã€‚
                      </p>
                       
                       <!-- User Inquiry Section -->
                       <table width="100%" cellpadding="0" cellspacing="0" class="section-container inquiry-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                         <tr>
                           <td class="section-content" style="padding: 25px;">
                             <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">æ‚¨çš„å’¨è¯¢</h3>
                             <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                               ${userMessage.replace(/\n/g, '<br>')}
                             </div>
                           </td>
                         </tr>
                       </table>
                       
                       <!-- Training Programs Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="section-container course-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                        <tr>
                          <td class="section-content" style="padding: 25px;">
                            <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">æ‚¨é€‰æ‹©çš„è¯¾ç¨‹</h3>
                            <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                              <strong>${getCourseInfo(language, course).title}</strong> (${getCourseInfo(language, course).duration}) - ${getCourseInfo(language, course).description}
                            </div>
                          </td>
                        </tr>
                      </table>
                      
                      <p style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 35px;">
                        åœ¨ç­‰å¾…æˆ‘ä»¬å›å¤æœŸé—´ï¼Œæ¬¢è¿æ‚¨æµè§ˆæˆ‘ä»¬çš„ç½‘ç«™ï¼Œäº†è§£æˆ‘ä»¬çš„ä¸–ç•Œçº§åŸ¹è®­è®¾æ–½ã€ç»éªŒä¸°å¯Œçš„è®²å¸ˆå’ŒæˆåŠŸçš„æ ¡å‹ç½‘ç»œã€‚
                      </p>
                      
                      <!-- Contact Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="contact-container" style="margin: 35px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 15px;">
                                  <a href="mailto:valentiacabincrew.academy@gmail.com" class="contact-button email-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">âœ‰</span>
                                    <span style="font-weight: 500;">å‘é€é‚®ä»¶</span>
                                  </a>
                                </td>
                                <td style="padding: 0 15px;">
                                  <a href="https://valentiaacademy.vercel.app/" class="contact-button website-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">ğŸŒ</span>
                                    <span style="font-weight: 500;">è®¿é—®ç½‘ç«™</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                      
                                            <!-- Social Media -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="social-container" style="margin: 30px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <p class="social-text" style="color: #7f8c8d; font-size: 13px; margin-bottom: 20px; font-style: italic;">å…³æ³¨æˆ‘ä»¬è·å–æœ€æ–°èµ„è®¯å’Œèˆªç©ºä¸šæ´å¯Ÿ</p>
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.instagram.com/jiehao_08/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text" style="font-size: 20px; color: white; font-weight: bold;">IG</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.linkedin.com/in/jie-hao-tee-4aa753290/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #0077b5; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text-small" style="font-size: 18px; color: white; font-weight: bold;">in</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.facebook.com/jie.hao.14/" class="social-icon" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #1877f2; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span class="social-icon-text" style="font-size: 20px; color: white; font-weight: bold;">f</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Footer -->
                  <tr>
                    <td style="text-align: center; color: #7f8c8d; padding: 30px; border-top: 1px solid #ecf0f1; border-radius: 0 0 8px 8px;">
                      <p style="margin: 5px 0; font-weight: 400; color: #2c3e50;">Valentiaç©ºä¹˜å­¦é™¢</p>
                      <p style="margin: 5px 0; font-size: 12px; font-style: italic;">æ‚¨çš„èˆªç©ºå“è¶Šä¹‹æ—…ä»è¿™é‡Œå¼€å§‹</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
        </html>
      `
    },
    ko: {
      subject: 'ë¬¸ì˜í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ - Valentia ê°ì‹¤ìŠ¹ë¬´ì› ì•„ì¹´ë°ë¯¸',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Valentia ê°ì‹¤ìŠ¹ë¬´ì› ì•„ì¹´ë°ë¯¸</title>
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
          <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4;">
            <tr>
              <td align="center" style="padding: 20px 0;">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                  <!-- Header -->
                  <tr>
                    <td style="background-color: #2c3e50; padding: 40px 30px; text-align: center; border-radius: 8px 8px 0 0;">
                      <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td style="text-align: center;">
                            <div class="logo-container" style="width: 80px; height: 80px; background-color: #ffffff; border-radius: 50%; margin: 0 auto 20px auto; display: inline-block; line-height: 80px; text-align: center; border: 3px solid #bdc3c7;">
                              <span class="logo-text" style="font-size: 32px; font-weight: bold; color: #2c3e50;">V</span>
                            </div>
                            <h1 class="header-title" style="margin: 0; font-size: 28px; font-weight: 300; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">Valentia</h1>
                            <p class="header-subtitle" style="margin: 8px 0 0 0; font-size: 14px; color: #bdc3c7; font-style: italic; letter-spacing: 1px;">ê°ì‹¤ìŠ¹ë¬´ì› ì•„ì¹´ë°ë¯¸</p>
                            <p class="header-tagline" style="margin: 15px 0 0 0; font-size: 12px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px;">í•­ê³µ êµìœ¡ì˜ ìš°ìˆ˜ì„±</p>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Main Content -->
                  <tr>
                    <td class="email-content" style="padding: 40px 30px;">
                      <h2 class="content-title" style="color: #2c3e50; margin-bottom: 25px; font-size: 22px; font-weight: 400;">ì¹œì• í•˜ëŠ” ${name}ë‹˜,</h2>
                      
                      <p class="content-text" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 20px;">
                        <strong>Valentia ê°ì‹¤ìŠ¹ë¬´ì› ì•„ì¹´ë°ë¯¸</strong>ì— ê´€ì‹¬ì„ ê°€ì ¸ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. í•­ê³µ ê²½ë ¥ ì—¬ì •ì„ ì‹œì‘í•˜ëŠ” ë° ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ ê¸°ì©ë‹ˆë‹¤.
                      </p>
                      
                      <p class="content-text-large" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 30px;">
                        ê·€í•˜ì˜ ë¬¸ì˜ë¥¼ ë°›ì•˜ìœ¼ë©°, ì €í¬ ì „ë‹´ í•­ê³µ ì „ë¬¸ê°€ íŒ€ì´ ê·€í•˜ì˜ ìš”ì²­ì„ ê²€í† í•˜ê³  <strong>24ì‹œê°„ ì´ë‚´</strong>ì— ë§ì¶¤í˜• ì •ë³´ë¥¼ ì œê³µí•´ë“œë¦´ ê²ƒì…ë‹ˆë‹¤.
                      </p>
                      
                      <!-- User Inquiry Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="section-container inquiry-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                        <tr>
                          <td class="section-content" style="padding: 25px;">
                            <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">ê·€í•˜ì˜ ë¬¸ì˜</h3>
                            <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                              ${userMessage.replace(/\n/g, '<br>')}
                            </div>
                          </td>
                        </tr>
                      </table>
                      
                                             <!-- Training Programs Section -->
                       <table width="100%" cellpadding="0" cellspacing="0" class="section-container course-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                         <tr>
                           <td class="section-content" style="padding: 25px;">
                             <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">ì„ íƒí•˜ì‹  ê³¼ì •</h3>
                             <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                               <strong>${getCourseInfo(language, course).title}</strong> (${getCourseInfo(language, course).duration}) - ${getCourseInfo(language, course).description}
                             </div>
                           </td>
                         </tr>
                       </table>
                      
                      <p style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 35px;">
                        ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì €í¬ ì›¹ì‚¬ì´íŠ¸ë¥¼ íƒìƒ‰í•˜ì—¬ ì„¸ê³„ì  ìˆ˜ì¤€ì˜ êµìœ¡ ì‹œì„¤, ê²½í—˜ä¸°å¯Œçš„í•œ ê°•ì‚¬ì§„, ì„±ê³µí•œ ë™ë¬¸ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•´ ë” ì•Œì•„ë³´ì„¸ìš”.
                      </p>
                      
                      <!-- Contact Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="contact-container" style="margin: 35px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 15px;">
                                  <a href="mailto:valentiacabincrew.academy@gmail.com" class="contact-button email-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">âœ‰</span>
                                    <span style="font-weight: 500;">ì´ë©”ì¼ ë³´ë‚´ê¸°</span>
                                  </a>
                                </td>
                                <td style="padding: 0 15px;">
                                  <a href="https://valentiaacademy.vercel.app/" class="contact-button website-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">ğŸŒ</span>
                                    <span style="font-weight: 500;">ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                      
                      <!-- Social Media -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="social-container" style="margin: 30px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <p class="social-text" style="color: #7f8c8d; font-size: 13px; margin-bottom: 20px; font-style: italic;">ìµœì‹  ì—…ë°ì´íŠ¸ì™€ í•­ê³µì—…ê³„ ë‰´ìŠ¤ë¥¼ ìœ„í•´ ì†Œì…œë¯¸ë””ì–´ë¥¼ íŒ”ë¡œìš°í•´ì£¼ì„¸ìš”</p>
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.instagram.com/jiehao_08/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 20px; color: white; font-weight: bold;">IG</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.linkedin.com/in/jie-hao-tee-4aa753290/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #0077b5; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 18px; color: white; font-weight: bold;">in</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.facebook.com/jie.hao.14/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #1877f2; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 20px; color: white; font-weight: bold;">f</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Footer -->
                  <tr>
                    <td class="email-footer" style="text-align: center; color: #7f8c8d; padding: 30px; border-top: 1px solid #ecf0f1; border-radius: 0 0 8px 8px;">
                      <p class="footer-title" style="margin: 5px 0; font-weight: 400; color: #2c3e50;">Valentia ê°ì‹¤ìŠ¹ë¬´ì› ì•„ì¹´ë°ë¯¸</p>
                      <p class="footer-text" style="margin: 5px 0; font-size: 12px; font-style: italic;">í•­ê³µ ìš°ìˆ˜ì„±ìœ¼ë¡œ ê°€ëŠ” ì—¬ì •ì´ ì—¬ê¸°ì„œ ì‹œì‘ë©ë‹ˆë‹¤</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
        </html>
      `
    },
    ja: {
      subject: 'ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ - Valentia ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Valentia ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼</title>
          <style>
            @media only screen and (max-width: 600px) {
              .email-container {
                width: 100% !important;
                max-width: 380px !important;
                border-radius: 20px !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
                overflow: hidden !important;
                margin: 0 auto !important;
              }
              .email-header {
                background: linear-gradient(135deg, #1a252f 0%, #2c3e50 50%, #34495e 100%) !important;
                padding: 36px 20px !important;
                position: relative !important;
              }
              .email-header::before {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(45deg, rgba(52, 152, 219, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%) !important;
                pointer-events: none !important;
              }
              .logo-container {
                width: 80px !important;
                height: 80px !important;
                line-height: 80px !important;
                border: 4px solid rgba(255,255,255,0.2) !important;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .logo-text {
                font-size: 32px !important;
                font-weight: 700 !important;
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
                -webkit-background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                background-clip: text !important;
              }
              .header-title {
                font-size: 26px !important;
                font-weight: 700 !important;
                letter-spacing: 2px !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .header-subtitle {
                font-size: 14px !important;
                font-weight: 500 !important;
                margin: 8px 0 0 0 !important;
                color: #ecf0f1 !important;
                letter-spacing: 1px !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .header-tagline {
                font-size: 12px !important;
                letter-spacing: 1.5px !important;
                font-weight: 600 !important;
                margin: 16px 0 0 0 !important;
                color: #bdc3c7 !important;
                text-transform: uppercase !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .email-content {
                padding: 28px 20px !important;
                background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%) !important;
              }
              .content-title {
                font-size: 30px !important;
                font-weight: 700 !important;
                margin-bottom: 24px !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .content-text {
                margin-bottom: 20px !important;
                line-height: 1.7 !important;
                font-size: 19px !important;
                color: #34495e !important;
              }
              .content-text-large {
                margin-bottom: 28px !important;
                line-height: 1.7 !important;
                font-size: 19px !important;
                color: #34495e !important;
              }
              .section-container {
                margin: 28px 0 !important;
                border-radius: 12px !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
                box-shadow: 0 4px 16px rgba(0,0,0,0.08) !important;
                border: 1px solid #e9ecef !important;
              }
              .section-content {
                padding: 24px !important;
              }
              .section-title {
                font-size: 24px !important;
                font-weight: 700 !important;
                margin-bottom: 16px !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .section-box {
                padding: 20px !important;
                border-radius: 10px !important;
                background: #ffffff !important;
                border: 1px solid #e9ecef !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
                font-size: 18px !important;
                line-height: 1.6 !important;
              }
              .inquiry-section {
                border-left: 5px solid #3498db !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;
              }
              .course-section {
                border-left: 5px solid #27ae60 !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%) !important;
              }
              .contact-container {
                margin: 32px 0 !important;
              }
              .contact-button {
                padding: 18px 28px !important;
                border: 2px solid !important;
                border-radius: 14px !important;
                font-size: 20px !important;
                font-weight: 700 !important;
                min-width: 140px !important;
                margin: 0 10px 20px 10px !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
                background: #ffffff !important;
              }
              .contact-button:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
              }
              .email-button {
                border-color: #3498db !important;
                color: #3498db !important;
              }
              .website-button {
                border-color: #27ae60 !important;
                color: #27ae60 !important;
              }
              .social-container {
                margin: 28px 0 !important;
              }
              .social-text {
                margin-bottom: 20px !important;
                font-size: 18px !important;
                color: #7f8c8d !important;
                font-style: italic !important;
                font-weight: 500 !important;
              }
              .social-icon {
                width: 60px !important;
                height: 60px !important;
                border-radius: 18px !important;
                line-height: 60px !important;
                margin: 0 10px !important;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                overflow: hidden !important;
              }
              .social-icon::before {
                content: '' !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%) !important;
                pointer-events: none !important;
              }
              .social-icon:hover {
                transform: translateY(-3px) !important;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
              }
              .social-icon-text {
                font-size: 24px !important;
                font-weight: 700 !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .social-icon-text-small {
                font-size: 22px !important;
                font-weight: 700 !important;
                position: relative !important;
                z-index: 1 !important;
              }
              .email-footer {
                padding: 28px 20px !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                border-top: 1px solid #dee2e6 !important;
              }
              .footer-title {
                font-weight: 700 !important;
                font-size: 20px !important;
                margin: 6px 0 !important;
                color: #2c3e50 !important;
                letter-spacing: 0.5px !important;
              }
              .footer-text {
                margin: 6px 0 !important;
                color: #6c757d !important;
                font-size: 17px !important;
                font-style: italic !important;
              }
            }
          </style>
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">
          <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f4;">
            <tr>
              <td align="center" style="padding: 20px 0;">
                <table width="600" cellpadding="0" cellspacing="0" class="email-container" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                  <!-- Header -->
                  <tr>
                    <td class="email-header" style="background-color: #2c3e50; padding: 40px 30px; text-align: center; border-radius: 8px 8px 0 0;">
                      <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td style="text-align: center;">
                            <div class="logo-container" style="width: 80px; height: 80px; background-color: #ffffff; border-radius: 50%; margin: 0 auto 20px auto; display: inline-block; line-height: 80px; text-align: center; border: 3px solid #bdc3c7;">
                              <span class="logo-text" style="font-size: 32px; font-weight: bold; color: #2c3e50;">V</span>
                            </div>
                            <h1 class="header-title" style="margin: 0; font-size: 28px; font-weight: 300; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;">Valentia</h1>
                            <p class="header-subtitle" style="margin: 8px 0 0 0; font-size: 14px; color: #bdc3c7; font-style: italic; letter-spacing: 1px;">ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼</p>
                            <p class="header-tagline" style="margin: 15px 0 0 0; font-size: 12px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px;">èˆªç©ºè¨“ç·´ã®å“è¶Šæ€§</p>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Main Content -->
                  <tr>
                    <td class="email-content" style="padding: 40px 30px;">
                      <h2 class="content-title" style="color: #2c3e50; margin-bottom: 25px; font-size: 22px; font-weight: 400;">${name}æ§˜</h2>
                      
                      <p class="content-text" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 20px;">
                        <strong>Valentia ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼</strong>ã«ã”èˆˆå‘³ã‚’ãŠæŒã¡ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚èˆªç©ºã‚­ãƒ£ãƒªã‚¢ã®æ—…ã‚’å§‹ã‚ã‚‹ãŠæ‰‹ä¼ã„ãŒã§ãã‚‹ã“ã¨ã‚’å¬‰ã—ãæ€ã„ã¾ã™ã€‚
                      </p>
                      
                      <p class="content-text-large" style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 30px;">
                        ãŠå®¢æ§˜ã®ãŠå•ã„åˆã‚ã›ã‚’å—ä¿¡ã„ãŸã—ã¾ã—ãŸã€‚å½“æ ¡ã®å°‚ä»»èˆªç©ºå°‚é–€å®¶ãƒãƒ¼ãƒ ãŒãŠå®¢æ§˜ã®ã”è¦æœ›ã‚’æ¤œè¨ã—ã€<strong>24æ™‚é–“ä»¥å†…</strong>ã«ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸè©³ç´°æƒ…å ±ã‚’ã”æä¾›ã„ãŸã—ã¾ã™ã€‚
                      </p>
                      
                      <!-- User Inquiry Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="section-container inquiry-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                        <tr>
                          <td class="section-content" style="padding: 25px;">
                            <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">ãŠå®¢æ§˜ã®ãŠå•ã„åˆã‚ã›</h3>
                            <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                              ${userMessage.replace(/\n/g, '<br>')}
                            </div>
                          </td>
                        </tr>
                      </table>
                      
                                             <!-- Training Programs Section -->
                       <table width="100%" cellpadding="0" cellspacing="0" class="section-container course-section" style="background-color: #f8f9fa; border-left: 4px solid #95a5a6; margin: 30px 0;">
                         <tr>
                           <td class="section-content" style="padding: 25px;">
                             <h3 class="section-title" style="color: #2c3e50; margin-top: 0; font-size: 18px; margin-bottom: 15px; font-weight: 400;">ãŠå®¢æ§˜ãŒé¸æŠã•ã‚ŒãŸã‚³ãƒ¼ã‚¹</h3>
                             <div class="section-box" style="color: #34495e; line-height: 1.6; font-size: 14px; margin: 0; padding: 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                               <strong>${getCourseInfo(language, course).title}</strong> (${getCourseInfo(language, course).duration}) - ${getCourseInfo(language, course).description}
                             </div>
                           </td>
                         </tr>
                       </table>
                      
                      <p style="line-height: 1.6; color: #34495e; font-size: 15px; margin-bottom: 35px;">
                        ãŠå¾…ã¡ã„ãŸã ã„ã¦ã„ã‚‹é–“ã€å½“æ ¡ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ã”è¦§ã„ãŸã ãã€ä¸–ç•Œã‚¯ãƒ©ã‚¹ã®è¨“ç·´æ–½è¨­ã€çµŒé¨“è±Šå¯Œãªè¬›å¸«é™£ã€æˆåŠŸã—ãŸå’æ¥­ç”Ÿãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ã„ã¦è©³ã—ãã”è¦§ãã ã•ã„ã€‚
                      </p>
                      
                      <!-- Contact Section -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="contact-container" style="margin: 35px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 15px;">
                                  <a href="mailto:valentiacabincrew.academy@gmail.com" class="contact-button email-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">âœ‰</span>
                                    <span style="font-weight: 500;">ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
                                  </a>
                                </td>
                                <td style="padding: 0 15px;">
                                  <a href="https://valentiaacademy.vercel.app/" class="contact-button website-button" style="text-decoration: none; color: #2c3e50; font-size: 14px; display: inline-block; padding: 15px 25px; border: 1px solid #bdc3c7; border-radius: 8px; background-color: #f8f9fa;">
                                    <span style="display: block; font-size: 24px; margin-bottom: 8px;">ğŸŒ</span>
                                    <span style="font-weight: 500;">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆè¨ªå•</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                      
                      <!-- Social Media -->
                      <table width="100%" cellpadding="0" cellspacing="0" class="social-container" style="margin: 30px 0;">
                        <tr>
                          <td style="text-align: center;">
                            <p class="social-text" style="color: #7f8c8d; font-size: 13px; margin-bottom: 20px; font-style: italic;">æœ€æ–°ã®æ›´æ–°æƒ…å ±ã¨èˆªç©ºæ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯ã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„</p>
                            <table cellpadding="0" cellspacing="0" style="margin: 0 auto;">
                              <tr>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.instagram.com/jiehao_08/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 20px; color: white; font-weight: bold;">IG</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.linkedin.com/in/jie-hao-tee-4aa753290/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #0077b5; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 18px; color: white; font-weight: bold;">in</span>
                                  </a>
                                </td>
                                <td style="padding: 0 8px;">
                                  <a href="https://www.facebook.com/jie.hao.14/" style="text-decoration: none; display: inline-block; width: 50px; height: 50px; background-color: #1877f2; border-radius: 12px; text-align: center; line-height: 50px;">
                                    <span style="font-size: 20px; color: white; font-weight: bold;">f</span>
                                  </a>
                                </td>
                              </tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  
                  <!-- Footer -->
                  <tr>
                    <td class="email-footer" style="text-align: center; color: #7f8c8d; padding: 30px; border-top: 1px solid #ecf0f1; border-radius: 0 0 8px 8px;">
                      <p class="footer-title" style="margin: 5px 0; font-weight: 400; color: #2c3e50;">Valentia ã‚­ãƒ£ãƒ“ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼</p>
                      <p class="footer-text" style="margin: 5px 0; font-size: 12px; font-style: italic;">èˆªç©ºå“è¶Šæ€§ã¸ã®æ—…ãŒã“ã“ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™</p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
        </html>
      `
    }
  };
  
  return templates[language] || templates.en;
};

// Test route
app.get('/api/test', (req, res) => {
  res.json({ 
    message: 'Valentia Backend Server is running!',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development'
  });
});

// Contact form endpoint
app.post('/api/contact', async (req, res) => {
  try {
    const { name, email, phone, message, course, language } = req.body;
    
    console.log('ğŸ“§ Received contact form submission:', { name, email, course, language });
    
    // Validate required fields
    if (!name || !email || !message) {
      return res.status(400).json({
        success: false,
        message: 'Missing required fields: name, email, and message are required'
      });
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({
        success: false,
        message: 'Invalid email format'
      });
    }
    
    // Send email to company
    const companyEmailOptions = {
      from: process.env.EMAIL_USER,
      to: process.env.EMAIL_USER,
      subject: `ğŸ†• New Contact Form Submission from ${name}`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 20px; text-align: center;">
            <h2 style="margin: 0;">ğŸ†• New Contact Form Submission</h2>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Valentia Cabin Crew Academy Website</p>
          </div>
          
          <div style="padding: 30px; background: #ffffff; border: 1px solid #e5e7eb;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold; width: 30%;">ğŸ‘¤ Name:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${name}</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“§ Email:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;"><a href="mailto:${email}">${email}</a></td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“± Phone:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${phone || 'Not provided'}</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“ Course:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${course || 'Not specified'}</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸŒ Language:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${language}</td>
              </tr>
            </table>
            
            <div style="margin-top: 20px;">
              <h3 style="color: #374151; margin-bottom: 10px;">ğŸ’¬ Message:</h3>
              <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                ${message.replace(/\n/g, '<br>')}
              </div>
            </div>
            
            <hr style="border: none; height: 1px; background: #e5e7eb; margin: 30px 0;">
            
            <p style="text-align: center; color: #6b7280; font-size: 14px; margin: 0;">
              ğŸ“… <strong>Submitted:</strong> ${new Date().toLocaleString()}<br>
              ğŸŒ <strong>Source:</strong> valentiaacademy.vercel.app
            </p>
          </div>
        </div>
      `
    };
    
         // Send auto-reply to customer
     const autoReply = getAutoReplyTemplate(language, name, message, course);
    const customerEmailOptions = {
      from: process.env.EMAIL_USER,
      to: email,
      subject: autoReply.subject,
      html: autoReply.html
    };
    
    // Send both emails
    console.log('ğŸ“¤ Sending emails...');
    await Promise.all([
      transporter.sendMail(companyEmailOptions),
      transporter.sendMail(customerEmailOptions)
    ]);
    
    console.log('âœ… Both emails sent successfully');
    
    res.json({
      success: true,
      message: 'Emails sent successfully'
    });
    
  } catch (error) {
    console.error('âŒ Error sending emails:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to send emails. Please try again later.'
    });
  }
});

// Handle course application submissions
app.post('/api/application', upload.array('attachments', 5), async (req, res) => {
  try {
    // Parse multipart form data
    const { name, email, phone, course, message, language } = req.body;
    const uploadedFiles = req.files || [];
    
    console.log('ğŸ“ New course application received:');
    console.log('ğŸ‘¤ Name:', name);
    console.log('ğŸ“§ Email:', email);
    console.log('ğŸ“± Phone:', phone);
    console.log('ğŸ“ Course:', course);
    console.log('ğŸŒ Language:', language);
    console.log('ğŸ“ Attachments:', uploadedFiles.length);
    
    // Validate required fields
    if (!name || !email || !phone || !course) {
      return res.status(400).json({
        success: false,
        message: 'Missing required fields'
      });
    }
    
    // Resolve language (prefer header), fallback to body
    const langHeader = (req.get('Accept-Language') || '').toLowerCase();
    const resolvedLang = (['en','zh','ko','ja'].includes((langHeader || '').slice(0,2))
      ? (langHeader || '').slice(0,2)
      : (language || 'en')).toLowerCase();

    // Get course information
    const courseInfo = getCourseInfo(resolvedLang || 'en', course);
    
    // Prepare company notification email with attachments
    const companyEmailOptions = {
      from: process.env.EMAIL_USER,
      to: process.env.EMAIL_USER, // Send to company email
      subject: `ğŸ“ New Course Application: ${courseInfo.title}`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
            <h1 style="margin: 0; font-size: 28px;">ğŸ“ New Course Application</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Valentia Cabin Crew Academy</p>
          </div>
          
          <div style="padding: 30px; background: #ffffff; border: 1px solid #e5e7eb;">
            <h2 style="color: #1e40af; margin-bottom: 20px;">ğŸ“‹ Application Details</h2>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold; width: 30%;">ğŸ‘¤ Name:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${name}</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“§ Email:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;"><a href="mailto:${email}">${email}</a></td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“± Phone:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${phone}</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸ“ Course:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${courseInfo.title} (${courseInfo.duration})</td>
              </tr>
              <tr>
                <td style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: bold;">ğŸŒ Language:</td>
                <td style="padding: 12px; border: 1px solid #e5e7eb;">${language || 'en'}</td>
              </tr>
            </table>
            
            ${message ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #374151; margin-bottom: 10px;">ğŸ’¬ Self Introduction:</h3>
              <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                ${message.replace(/\n/g, '<br>')}
              </div>
            </div>
            ` : ''}
            
            ${uploadedFiles.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #374151; margin-bottom: 10px;">ğŸ“ Attachments (${uploadedFiles.length}):</h3>
              <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                ${uploadedFiles.map(file => `<div style="margin-bottom: 5px;">ğŸ“„ ${file.originalname} (${(file.size / 1024).toFixed(1)} KB)</div>`).join('')}
                <p style="margin-top: 10px; color: #6b7280; font-size: 12px;">
                  ğŸ’¡ <strong>Note:</strong> Attachments are included below this email and can be downloaded.
                </p>
              </div>
            </div>
            ` : ''}
            
            <hr style="border: none; height: 1px; background: #e5e7eb; margin: 30px 0;">
            
            <p style="text-align: center; color: #6b7280; font-size: 14px; margin: 0;">
              ğŸ“… <strong>Submitted:</strong> ${new Date().toLocaleString()}<br>
              ğŸŒ <strong>Source:</strong> Course Application Form
            </p>
          </div>
        </div>
      `,
      ...(uploadedFiles.length > 0 && {
        attachments: uploadedFiles.map(file => {
          const filePath = path.join(uploadsDir, file.filename);
          // Read file content for reliable email attachment handling
          const fileContent = fs.readFileSync(filePath);
          return {
        filename: file.originalname,
            content: fileContent,
            contentType: file.mimetype || 'application/octet-stream'
          };
        })
      })
    };
    
    // i18n labels for customer confirmation (design unchanged)
    const i18n = {
      subject: {
        en: 'Application Received',
        zh: 'ç”³è¯·å·²æ”¶åˆ°',
        ko: 'ì‹ ì²­ ì ‘ìˆ˜',
        ja: 'ç”³è¾¼å—ä»˜'
      },
      dear: { en: 'Dear', zh: 'å°Šæ•¬çš„', ko: 'ì•ˆë…•í•˜ì„¸ìš”', ja: 'Dear' },
      introPrefix: {
        en: 'Thank you for your interest in our',
        zh: 'æ„Ÿè°¢æ‚¨å¯¹æˆ‘ä»¬',
        ko: 'ë‹¤ìŒ í”„ë¡œê·¸ë¨ì— ê´€ì‹¬ì„ ê°€ì ¸ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤:',
        ja: 'å½“æ ¡ã®'
      },
      introSuffix: {
        en: 'program. We have received your application and are excited about your potential to join our aviation training program.',
        zh: 'é¡¹ç›®çš„å…³æ³¨ã€‚æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„ç”³è¯·ï¼ŒæœŸå¾…æ‚¨åŠ å…¥æˆ‘ä»¬çš„èˆªç©ºåŸ¹è®­é¡¹ç›®ã€‚',
        ko: 'í”„ë¡œê·¸ë¨ì— ì§€ì›í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ê·€í•˜ì˜ ì§€ì›ì„œë¥¼ ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤.',
        ja: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã”é–¢å¿ƒã‚’ãŠå¯„ã›ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠç”³ã—è¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚'
      },
      summary: { en: 'Application Summary', zh: 'ç”³è¯·æ‘˜è¦', ko: 'ì‹ ì²­ ìš”ì•½', ja: 'ç”³è¾¼æ¦‚è¦' },
      course: { en: 'Course', zh: 'è¯¾ç¨‹', ko: 'ì½”ìŠ¤', ja: 'ã‚³ãƒ¼ã‚¹' },
      duration: { en: 'Duration', zh: 'æ—¶é•¿', ko: 'ê¸°ê°„', ja: 'æœŸé–“' },
      description: { en: 'Description', zh: 'ç®€ä»‹', ko: 'ì„¤ëª…', ja: 'èª¬æ˜' },
      nextTitle: { en: 'What Happens Next?', zh: 'ä¸‹ä¸€æ­¥', ko: 'ë‹¤ìŒ ë‹¨ê³„', ja: 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—' },
      next: {
        en: [
          'Our admissions team will review your application within 24 hours',
          'We will contact you via email or phone to discuss next steps',
          'You may be invited for an interview or additional assessment',
          "Upon acceptance, you'll receive detailed enrollment information"
        ],
        zh: [
          'æ‹›ç”Ÿå›¢é˜Ÿå°†åœ¨24å°æ—¶å†…å®¡æ ¸æ‚¨çš„ç”³è¯·',
          'æˆ‘ä»¬å°†é€šè¿‡é‚®ç®±æˆ–ç”µè¯ä¸æ‚¨è”ç³»ï¼Œå‘ŠçŸ¥ä¸‹ä¸€æ­¥',
          'æ‚¨å¯èƒ½ä¼šè¢«é‚€è¯·å‚åŠ é¢è¯•æˆ–é¢å¤–è¯„ä¼°',
          'å½•å–åæ‚¨å°†æ”¶åˆ°è¯¦ç»†çš„å…¥å­¦æŒ‡å—'
        ],
        ko: [
          'ì…í•™íŒ€ì´ 24ì‹œê°„ ì´ë‚´ì— ì§€ì›ì„œë¥¼ ê²€í† í•©ë‹ˆë‹¤',
          'ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë¡œ ë‹¤ìŒ ì ˆì°¨ë¥¼ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤',
          'ë©´ì ‘ ë˜ëŠ” ì¶”ê°€ í‰ê°€ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤',
          'í•©ê²© ì‹œ ìƒì„¸ ë“±ë¡ ì•ˆë‚´ë¥¼ ë°›ê²Œ ë©ë‹ˆë‹¤'
        ],
        ja: [
          'å½“æ ¡ã®ã‚¢ãƒ‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ãŒ24æ™‚é–“ä»¥å†…ã«ç”³è¾¼å†…å®¹ã‚’ç¢ºèªã—ã¾ã™',
          'ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯ãŠé›»è©±ã§æ¬¡ã®æ‰‹é †ã‚’ã”æ¡ˆå†…ã„ãŸã—ã¾ã™',
          'é¢æ¥ã¾ãŸã¯è¿½åŠ ã®è©•ä¾¡ã«ã”æ¡ˆå†…ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™',
          'åˆæ ¼å¾Œã€è©³ç´°ãªå…¥å­¦æ¡ˆå†…ã‚’ãŠé€ã‚Šã—ã¾ã™'
        ]
      },
      important: { en: 'Important Note', zh: 'é‡è¦æç¤º', ko: 'ì¤‘ìš” ì•ˆë‚´', ja: 'é‡è¦ãªãŠçŸ¥ã‚‰ã›' },
      importantText: {
        en: 'Please ensure your contact information is correct. If you need to update any details, please reply to this email or contact us directly.',
        zh: 'è¯·ç¡®ä¿æ‚¨çš„è”ç³»æ–¹å¼æ­£ç¡®ã€‚å¦‚éœ€æ›´æ–°ä¿¡æ¯ï¼Œè¯·ç›´æ¥å›å¤æ­¤é‚®ä»¶æˆ–ä¸æˆ‘ä»¬è”ç³»ã€‚',
        ko: 'ì—°ë½ì²˜ ì •ë³´ê°€ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. ë³€ê²½ì´ í•„ìš”í•˜ë©´ ì´ ë©”ì¼ì— íšŒì‹ í•˜ê±°ë‚˜ ì§ì ‘ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.',
        ja: 'ã”é€£çµ¡å…ˆãŒæ­£ã—ã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯æœ¬ãƒ¡ãƒ¼ãƒ«ã¸ã”è¿”ä¿¡ã„ãŸã ãã‹ã€ç›´æ¥ã”é€£çµ¡ãã ã•ã„ã€‚'
      },
      contact: { en: 'Contact', zh: 'è”ç³»é‚®ç®±', ko: 'ì´ë©”ì¼', ja: 'é€£çµ¡å…ˆ' },
      phone:   { en: 'Phone', zh: 'ç”µè¯', ko: 'é›»è©±', ja: 'é›»è©±' },
      website: { en: 'Website', zh: 'ç½‘ç«™', ko: 'ì›¹ã‚µã‚¤ãƒˆ', ja: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ' }
    };

    // Prepare customer confirmation email with attachments
    const customerEmailOptions = {
      from: process.env.EMAIL_USER,
      to: email,
      subject: `ğŸ“ ${i18n.subject[resolvedLang]} - ${courseInfo.title}`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
            <h1 style="margin: 0; font-size: 28px;">ğŸ“ ${i18n.subject[resolvedLang]}</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Valentia Cabin Crew Academy</p>
          </div>
          
          <div style="padding: 30px; background: #ffffff; border: 1px solid #e5e7eb;">
            <h2 style="color: #1e40af; margin-bottom: 20px;">${i18n.dear[resolvedLang]} ${name},</h2>
            
            <p style="color: #374151; line-height: 1.6; margin-bottom: 20px;">
              ${i18n.introPrefix[resolvedLang]} <strong>${courseInfo.title}</strong> ${i18n.introSuffix[resolvedLang]}
            </p>
            
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #0c4a6e; margin: 0 0 15px 0;">ğŸ“‹ ${i18n.summary[resolvedLang]}</h3>
              <p style="margin: 0; color: #0c4a6e;"><strong>${i18n.course[resolvedLang]}:</strong> ${courseInfo.title}</p>
              <p style="margin: 0; color: #0c4a6e;"><strong>${i18n.duration[resolvedLang]}:</strong> ${courseInfo.duration}</p>
              <p style="margin: 0; color: #0c4a6e;"><strong>${i18n.description[resolvedLang]}:</strong> ${courseInfo.description}</p>
            </div>
            
            ${uploadedFiles.length > 0 ? `
            <div style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #374151; margin: 0 0 15px 0;">ğŸ“ ${resolvedLang==='zh'?'æ‚¨æäº¤çš„æ–‡ä»¶':resolvedLang==='ko'?'ì œì¶œí•˜ì‹  ë¬¸ì„œ':resolvedLang==='ja'?'æå‡ºã•ã‚ŒãŸæ›¸é¡':'Your Submitted Documents'}</h3>
              <p style="margin: 0; color: #6b7280; font-size: 14px;">${resolvedLang==='zh'?'æˆ‘ä»¬å·²æ”¶åˆ°ä»¥ä¸‹éšç”³è¯·æäº¤çš„æ–‡ä»¶ï¼š':resolvedLang==='ko'?'ì•„ë˜ ë¬¸ì„œë¥¼ ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤:':resolvedLang==='ja'?'ä»¥ä¸‹ã®æ›¸é¡ã‚’å—é ˜ã—ã¾ã—ãŸã€‚':'We have received the following documents with your application:'}</p>
              <div style="margin-top: 10px;">
                ${uploadedFiles.map(file => `<div style="margin-bottom: 5px;">ğŸ“„ ${file.originalname} (${(file.size / 1024).toFixed(1)} KB)</div>`).join('')}
              </div>
              <p style="margin-top: 10px; color: #6b7280; font-size: 12px;">ğŸ’¡ <strong>${resolvedLang==='zh'?'å¤‡æ³¨':'Note'}:</strong> ${resolvedLang==='zh'?'ä»¥ä¸‹æ–‡ä»¶é™„åœ¨æœ¬é‚®ä»¶åº•éƒ¨ä»¥ä¾›å‚è€ƒã€‚':resolvedLang==='ko'?'í•´ë‹¹ ë¬¸ì„œëŠ” ì´ë©”ì¼ í•˜ë‹¨ì— ì²¨ë¶€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.':resolvedLang==='ja'?'ã“ã‚Œã‚‰ã®æ›¸é¡ã¯æœ¬ãƒ¡ãƒ¼ãƒ«ã®ä¸‹éƒ¨ã«æ·»ä»˜ã•ã‚Œã¦ã„ã¾ã™ã€‚':'These documents are included below this email for your reference.'}</p>
            </div>
            ` : ''}
            
            <h3 style="color: #374151; margin-bottom: 15px;">ğŸ“… ${i18n.nextTitle[resolvedLang]}</h3>
            <ol style="color: #374151; line-height: 1.6; padding-left: 20px;">
              ${i18n.next[resolvedLang].map(item => `<li>${item}</li>`).join('')}
            </ol>
            
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #92400e; margin: 0 0 10px 0;">âš ï¸ ${i18n.important[resolvedLang]}</h3>
              <p style="margin: 0; color: #92400e; font-size: 14px;">${i18n.importantText[resolvedLang]}</p>
            </div>
            
            <hr style="border: none; height: 1px; background: #e5e7eb; margin: 30px 0;">
            
            <p style="text-align: center; color: #6b7280; font-size: 14px; margin: 0;">
              ğŸ“§ <strong>${i18n.contact[resolvedLang]}:</strong> valentiacabincrew.academy@gmail.com<br>
              ğŸ“± <strong>${i18n.phone[resolvedLang]}:</strong> +603-12345678<br>
              ğŸŒ <strong>${i18n.website[resolvedLang]}:</strong> valentiaacademy.vercel.app
            </p>
          </div>
        </div>
      `,
      ...(uploadedFiles.length > 0 && {
        attachments: uploadedFiles.map(file => {
          const filePath = path.join(uploadsDir, file.filename);
          // Read file content for reliable email attachment handling
          const fileContent = fs.readFileSync(filePath);
          return {
        filename: file.originalname,
            content: fileContent,
            contentType: file.mimetype || 'application/octet-stream'
          };
        })
      })
    };
    
    // Generate application ID
    const applicationId = generateApplicationId();
    
    // Save application to database
    const insertResult = applications.create.run(
      applicationId,
      name,
      email,
      phone,
      course,
      message || null,
      resolvedLang,
      req.ip,
      req.get('user-agent') || null
    );
    
    const applicationDbId = insertResult.lastInsertRowid;
    
    // Save attachments to database and file system
    if (uploadedFiles && uploadedFiles.length > 0) {
      for (const file of uploadedFiles) {
        // File is already saved by multer diskStorage
        if (attachments && attachments.create && typeof attachments.create.run === 'function') {
          attachments.create.run(
            applicationDbId,
            file.originalname,
            file.filename,
            file.size,
            file.mimetype
          );
        } else {
          console.warn('Attachment persistence is not available in the current DB adapter.');
        }
      }
    }
    
    // Send both emails
    console.log('ğŸ“¤ Sending application emails...');
    await Promise.all([
      transporter.sendMail(companyEmailOptions),
      transporter.sendMail(customerEmailOptions)
    ]);
    
    console.log('âœ… Application emails sent successfully');
    console.log(`ğŸ’¾ Application saved to database: ${applicationId}`);
    
    res.json({
      success: true,
      message: 'Application submitted successfully',
      applicationId: applicationId
    });
    
  } catch (error) {
    console.error('âŒ Error processing application:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to submit application. Please try again later.'
    });
  }
});

// ==================== ADMIN API ENDPOINTS ====================

// Authentication middleware
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ success: false, message: 'Access token required' });
  }

  jwt.verify(token, process.env.JWT_SECRET || 'valentia-secret-key-change-in-production', (err, user) => {
    if (err) {
      return res.status(403).json({ success: false, message: 'Invalid or expired token' });
    }
    req.user = user;
    next();
  });
};

// Admin login
app.post('/api/admin/auth/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({
        success: false,
        message: 'Username and password are required'
      });
    }

    const user = adminUsers.getByUsername.get(username);
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'Invalid username or password'
      });
    }

    const validPassword = await bcrypt.compare(password, user.password_hash);
    if (!validPassword) {
      return res.status(401).json({
        success: false,
        message: 'Invalid username or password'
      });
    }

    // Update last login
    adminUsers.updateLastLogin.run(user.id);

    // Generate JWT token
    const token = jwt.sign(
      { id: user.id, username: user.username, role: user.role },
      process.env.JWT_SECRET || 'valentia-secret-key-change-in-production',
      { expiresIn: '24h' }
    );

    res.json({
      success: true,
      token,
      user: {
        id: user.id,
        username: user.username,
        email: user.email,
        role: user.role
      }
    });
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({
      success: false,
      message: 'Login failed'
    });
  }
});

// Get current user
app.get('/api/admin/auth/me', authenticateToken, (req, res) => {
  const user = adminUsers.getByUsername.get(req.user.username);
  if (!user) {
    return res.status(404).json({ success: false, message: 'User not found' });
  }
  res.json({
    success: true,
    user: {
      id: user.id,
      username: user.username,
      email: user.email,
      role: user.role
    }
  });
});

// Get all applications with filters
app.get('/api/admin/applications', authenticateToken, (req, res) => {
  try {
    const {
      page = 1,
      limit = 50,
      course = 'all',
      status = 'all',
      language = 'all',
      search = '',
      dateFrom = '',
      dateTo = ''
    } = req.query;

    const searchTerm = `%${search}%`;
    const offset = (parseInt(page) - 1) * parseInt(limit);

    // Get filtered applications
    const allApplications = applications.search.all(
      searchTerm, searchTerm, searchTerm, searchTerm,
      course, course,
      status, status,
      language, language,
      dateFrom, dateFrom,
      dateTo, dateTo
    );

    // Paginate
    const total = allApplications.length;
    const paginatedApplications = allApplications.slice(offset, offset + parseInt(limit));

    res.json({
      success: true,
      applications: paginatedApplications,
      pagination: {
        total,
        page: parseInt(page),
        limit: parseInt(limit),
        totalPages: Math.ceil(total / parseInt(limit))
      }
    });
  } catch (error) {
    console.error('Error fetching applications:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch applications'
    });
  }
});

// Get single application by ID
app.get('/api/admin/applications/:id', authenticateToken, (req, res) => {
  try {
    const id = parseInt(req.params.id);
    const application = applications.getById.get(id);

    if (!application) {
      return res.status(404).json({
        success: false,
        message: 'Application not found'
      });
    }

    // Get attachments
    const applicationAttachments = attachments.getByApplicationId.all(id);

    // Get notes
    const applicationNotes = notes.getByApplicationId.all(id);

    // Get status history
    const history = statusHistory.getByApplicationId.all(id);

    res.json({
      success: true,
      application: {
        ...application,
        attachments: applicationAttachments,
        notes: applicationNotes,
        statusHistory: history
      }
    });
  } catch (error) {
    console.error('Error fetching application:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch application'
    });
  }
});

// Update application status
app.put('/api/admin/applications/:id', authenticateToken, (req, res) => {
  try {
    const id = parseInt(req.params.id);
    const { status, reviewerNotes } = req.body;

    const application = applications.getById.get(id);
    if (!application) {
      return res.status(404).json({
        success: false,
        message: 'Application not found'
      });
    }

    const oldStatus = application.status;
    const newStatus = status || application.status;

    // Update application
    applications.update.run(newStatus, req.user.username, id);

    // Save status history
    statusHistory.create.run(
      id,
      oldStatus,
      newStatus,
      req.user.username,
      reviewerNotes || null
    );

    // If reviewer notes provided, add as note
    if (reviewerNotes) {
      notes.create.run(id, reviewerNotes, 'internal', req.user.username);
    }

    res.json({
      success: true,
      message: 'Application updated successfully'
    });
  } catch (error) {
    console.error('Error updating application:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to update application'
    });
  }
});

// Add note to application
app.post('/api/admin/applications/:id/notes', authenticateToken, (req, res) => {
  try {
    const id = parseInt(req.params.id);
    const { content, noteType = 'note' } = req.body;

    if (!content) {
      return res.status(400).json({
        success: false,
        message: 'Note content is required'
      });
    }

    const application = applications.getById.get(id);
    if (!application) {
      return res.status(404).json({
        success: false,
        message: 'Application not found'
      });
    }

    notes.create.run(id, content, noteType, req.user.username);

    res.json({
      success: true,
      message: 'Note added successfully'
    });
  } catch (error) {
    console.error('Error adding note:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to add note'
    });
  }
});

// Delete application
app.delete('/api/admin/applications/:id', authenticateToken, (req, res) => {
  try {
    // Only admin can delete
    if (req.user.role !== 'admin') {
      return res.status(403).json({
        success: false,
        message: 'Only administrators can delete applications'
      });
    }

    const id = parseInt(req.params.id);
    const application = applications.getById.get(id);

    if (!application) {
      return res.status(404).json({
        success: false,
        message: 'Application not found'
      });
    }

    // Delete attachments from file system
    const applicationAttachments = attachments.getByApplicationId.all(id);
    for (const att of applicationAttachments) {
      const filePath = path.join(uploadsDir, att.file_path);
      if (fs.existsSync(filePath)) {
        fs.unlinkSync(filePath);
      }
    }

    // Delete from database (cascade will handle related records)
    applications.delete.run(id);

    res.json({
      success: true,
      message: 'Application deleted successfully'
    });
  } catch (error) {
    console.error('Error deleting application:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to delete application'
    });
  }
});

// Bulk delete applications
app.post('/api/admin/applications/bulk-delete', authenticateToken, (req, res) => {
  try {
    // Only admin can delete
    if (req.user.role !== 'admin') {
      return res.status(403).json({
        success: false,
        message: 'Only administrators can delete applications'
      });
    }

    const { ids } = req.body;
    
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'No applications selected'
      });
    }

    let deletedCount = 0;
    
    for (const id of ids) {
      const appId = parseInt(id);
      const application = applications.getById.get(appId);
      
      if (application) {
        // Delete attachments from file system
        const applicationAttachments = attachments.getByApplicationId.all(appId);
        for (const att of applicationAttachments) {
          const filePath = path.join(uploadsDir, att.file_path);
          if (fs.existsSync(filePath)) {
            try {
              fs.unlinkSync(filePath);
            } catch (err) {
              console.error(`Failed to delete file ${filePath}:`, err);
            }
          }
        }

        // Delete from database
        applications.delete.run(appId);
        deletedCount++;
      }
    }

    res.json({
      success: true,
      message: `${deletedCount} applications deleted successfully`,
      deletedCount
    });
  } catch (error) {
    console.error('Error deleting applications:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to delete applications'
    });
  }
});

// Get dashboard statistics
app.get('/api/admin/dashboard/stats', authenticateToken, (req, res) => {
  try {
    const stats = applications.getStats.get();
    const byCourse = applications.getByCourse.all();
    const byStatus = applications.getByStatus.all();

    // Get timeline data (last 30 days)
    const timeline = [];
    for (let i = 29; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayStats = applications.search.all(
        '%%', '%%', '%%', '%%',
        'all', 'all',
        'all', 'all',
        'all', 'all',
        dateStr, dateStr,
        dateStr, dateStr
      );
      timeline.push({
        date: dateStr,
        count: dayStats.length
      });
    }

    res.json({
      success: true,
      stats: {
        total: stats.total,
        today: stats.today,
        thisWeek: stats.this_week,
        thisMonth: stats.this_month,
        pending: stats.pending,
        byCourse: byCourse.reduce((acc, item) => {
          acc[item.course] = item.count;
          return acc;
        }, {}),
        byStatus: byStatus.reduce((acc, item) => {
          acc[item.status] = item.count;
          return acc;
        }, {}),
        timeline
      }
    });
  } catch (error) {
    console.error('Error fetching stats:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch statistics'
    });
  }
});

// Export applications to Excel
app.get('/api/admin/applications/export/excel', authenticateToken, async (req, res) => {
  try {
    console.log('Export request query:', req.query); // Debug log
    const {
      course = 'all',
      status = 'all',
      language = 'all',
      search = '',
      dateFrom = '',
      dateTo = '',
      ids
    } = req.query;

    let apps;

    if (ids) {
      // Export specific applications
      const idList = ids.split(',').map(id => parseInt(id));
      apps = idList.map(id => applications.getById.get(id)).filter(app => app);
    } else {
      // Export filtered applications
      const searchTerm = `%${search}%`;
      apps = applications.search.all(
        searchTerm, searchTerm, searchTerm, searchTerm,
        course, course,
        status, status,
        language, language,
        dateFrom, dateFrom,
        dateTo, dateTo
      );
    }

    // Create workbook
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Applications');

    // Define columns
    worksheet.columns = [
      { header: 'Application ID', key: 'application_id', width: 20 },
      { header: 'Full Name', key: 'full_name', width: 25 },
      { header: 'Email', key: 'email', width: 30 },
      { header: 'Phone', key: 'phone', width: 15 },
      { header: 'Course', key: 'course', width: 20 },
      { header: 'Status', key: 'status', width: 15 },
      { header: 'Language', key: 'language_preference', width: 12 },
      { header: 'Message', key: 'message', width: 50 },
      { header: 'Attachments', key: 'attachment_count', width: 12 },
      { header: 'Submitted Date', key: 'created_at', width: 20 },
      { header: 'Reviewed By', key: 'reviewed_by', width: 20 },
      { header: 'Reviewed Date', key: 'reviewed_at', width: 20 }
    ];

    // Style header row
    worksheet.getRow(1).font = { bold: true };
    worksheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FF1e40af' }
    };
    worksheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
    worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

    // Add data rows
    apps.forEach(app => {
      const row = worksheet.addRow({
        application_id: app.application_id,
        full_name: app.full_name,
        email: app.email,
        phone: app.phone,
        course: app.course,
        status: app.status,
        language_preference: app.language_preference,
        message: app.message || '',
        attachment_count: app.attachment_count || 0,
        created_at: app.created_at,
        reviewed_by: app.reviewed_by || '',
        reviewed_at: app.reviewed_at || ''
      });

      // Format date columns
      row.getCell('created_at').numFmt = 'yyyy-mm-dd hh:mm:ss';
      if (app.reviewed_at) {
        row.getCell('reviewed_at').numFmt = 'yyyy-mm-dd hh:mm:ss';
      }

      // Status color coding (guard font creation)
      const statusCell = row.getCell('status');
      const setStyle = (fg) => {
        statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fg } };
        statusCell.font = { ...(statusCell.font || {}), color: { argb: 'FFFFFFFF' } };
      };
      switch (app.status) {
        case 'accepted':
          setStyle('FF10b981');
          break;
        case 'rejected':
          setStyle('FFef4444');
          break;
        case 'under_review':
          setStyle('FFf59e0b');
          break;
        case 'pending':
          setStyle('FF6b7280');
          break;
      }
    });

    // Freeze header row
    worksheet.views = [{ state: 'frozen', ySplit: 1 }];

    // Generate filename
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const filename = `applications-export-${timestamp}.xlsx`;

    // Set response headers
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);

    // Write to response
    await workbook.xlsx.write(res);
    res.end();
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to export applications'
    });
  }
});

// Download attachment file
app.get('/api/admin/applications/:id/attachments/:attachmentId', authenticateToken, (req, res) => {
  try {
    const attachmentId = parseInt(req.params.attachmentId);
    const applicationId = parseInt(req.params.id);

    // Get attachment info
    const applicationAttachments = attachments.getByApplicationId.all(applicationId);
    const attachment = applicationAttachments.find(a => a.id === attachmentId);

    if (!attachment) {
      return res.status(404).json({
        success: false,
        message: 'Attachment not found'
      });
    }

    const filePath = path.join(uploadsDir, attachment.file_path);
    if (!fs.existsSync(filePath)) {
      return res.status(404).json({
        success: false,
        message: 'File not found'
      });
    }

    // Determine correct Content-Type
    let contentType = attachment.file_type || 'application/octet-stream';
    // Ensure PDF files get the correct Content-Type
    if (attachment.file_name.toLowerCase().endsWith('.pdf')) {
      contentType = 'application/pdf';
    } else if (!contentType || contentType === 'application/octet-stream') {
      // Try to infer from file extension
      const ext = path.extname(attachment.file_name).toLowerCase();
      const mimeTypes = {
        '.jpg': 'image/jpeg',
        '.jpeg': 'image/jpeg',
        '.png': 'image/png',
        '.doc': 'application/msword',
        '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      };
      contentType = mimeTypes[ext] || contentType;
    }

    // Encode filename for proper download (handle special characters)
    const encodedFilename = encodeURIComponent(attachment.file_name);
    
    res.setHeader('Content-Disposition', `attachment; filename="${encodedFilename}"; filename*=UTF-8''${encodedFilename}`);
    res.setHeader('Content-Type', contentType);
    res.setHeader('Cache-Control', 'no-cache');
    
    // Send file using absolute path
    res.sendFile(path.resolve(filePath));
  } catch (error) {
    console.error('Error downloading attachment:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to download attachment'
    });
  }
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('Server error:', err);
  res.status(500).json({
    success: false,
    message: 'Internal server error'
  });
});

// 404 handler
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: 'API endpoint not found'
  });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log(`\nğŸš€ Valentia Backend Server is running on port ${PORT}`);
  console.log(`ğŸ“§ Email service: ${process.env.EMAIL_USER ? 'Configured' : 'Not configured'}`);
  console.log(`ğŸŒ Frontend URL: ${process.env.FRONTEND_URL || 'http://localhost:5173'}`);
  console.log(`ğŸ”— Test API: http://localhost:${PORT}/api/test\n`);
});
